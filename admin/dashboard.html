<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>لوحة تحكم منصة العمرة</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/manage_admin.css" />
    <link rel="stylesheet" href="css/dashboard.css" />
    <!-- Supabase JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Sidebar -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="logo">
            <i class="fas fa-kaaba"></i>
            <span class="sidebar-text">العمرة</span>
          </div>
          <p
            class="sidebar-text"
            data-ar="منصة إدارة العمرة"
            data-en="Umrah Management Platform"
            data-fr="Plateforme de Gestion Omra"
          >
            منصة إدارة العمرة
          </p>
        </div>
        <ul class="sidebar-menu">
          <li>
            <a href="#" class="active">
              <i class="fas fa-tachometer-alt"></i>
              <span
                class="sidebar-text"
                data-ar="لوحة التحكم"
                data-en="Dashboard"
                data-fr="Tableau de bord"
                >لوحة التحكم</span
              >
            </a>
          </li>
          <li>
            <a href="manage_agencies.html">
              <i class="fas fa-building"></i>
              <span
                class="sidebar-text"
                data-ar="إدارة الوكالات"
                data-en="Manage Agencies"
                data-fr="Gérer les Agences"
                >إدارة الوكالات</span
              >
            </a>
          </li>
          <li>
            <a href="demande_umrah.php">
              <i class="fas fa-users"></i>
              <span
                class="sidebar-text"
                data-ar="إدارة المعتمرين"
                data-en="Manage Pilgrims"
                data-fr="Gérer les Pèlerins"
                >إدارة المعتمرين</span
              >
            </a>
          </li>
          <li>
            <a href="manage_offers.php">
              <i class="fas fa-tags"></i>
              <span
                class="sidebar-text"
                data-ar="إدارة العروض"
                data-en="Manage Offers"
                data-fr="Gérer les Offres"
                >إدارة العروض</span
              >
            </a>
          </li>
          <li>
            <a href="manage_requests.php">
              <i class="fas fa-clipboard-list"></i>
              <span
                class="sidebar-text"
                data-ar="إدارة الطلبات"
                data-en="Manage Requests"
                data-fr="Gérer les Demandes"
                >إدارة الطلبات</span
              >
            </a>
          </li>
          <li>
            <a href="manage_admins.php">
              <i class="fas fa-user-shield"></i>
              <span
                class="sidebar-text"
                data-ar="إدارة المدراء"
                data-en="Manage Admins"
                data-fr="Gérer les Admins"
                >إدارة المدراء</span
              >
            </a>
          </li>
          <!-- <li>
                        <a href="manage_sub_admins.php">
                            <i class="fas fa-user-cog"></i>
                            <span class="sidebar-text" data-ar="إدارة المدراء الثانويين" data-en="Manage Secondary Admins" data-fr="Gérer les Admins Secondaires">إدارة المدراء الثانويين</span>
                        </a>
                    </li> -->
          <li>
            <a href="#">
              <i class="fas fa-comments"></i>
              <span
                class="sidebar-text"
                data-ar="الدردشة"
                data-en="Chat"
                data-fr="Chat"
                >الدردشة</span
              >
            </a>
          </li>
          <li>
            <a href="#">
              <i class="fas fa-chart-bar"></i>
              <span
                class="sidebar-text"
                data-ar="التقارير"
                data-en="Reports"
                data-fr="Rapports"
                >التقارير</span
              >
            </a>
          </li>
          <li>
            <a href="#">
              <i class="fas fa-cogs"></i>
              <span
                class="sidebar-text"
                data-ar="الإعدادات"
                data-en="Settings"
                data-fr="Paramètres"
                >الإعدادات</span
              >
            </a>
          </li>
        </ul>
      </div>
      <div class="main-content">
        <!-- Header -->
        <div class="header">
          <div class="header-left">
            <h1
              data-ar="إدارة الوكالات السياحية"
              data-en="Manage Travel Agencies"
              data-fr="Gérer les Agences de Voyage"
            >
              إدارة الوكالات السياحية
            </h1>
            <p
              data-ar="عرض وإدارة جميع الوكالات المسجلة في النظام"
              data-en="View and manage all registered agencies in the system"
              data-fr="Voir et gérer toutes les agences enregistrées dans le système"
            >
              عرض وإدارة جميع الوكالات المسجلة في النظام
            </p>
          </div>
          <div class="header-right">
            <div class="language-switcher">
              <button class="lang-btn active" data-lang="ar">العربية</button>
              <button class="lang-btn" data-lang="en">English</button>
              <button class="lang-btn" data-lang="fr">Français</button>
            </div>
            <div class="user-info">
              <div class="user-avatar">
                <i class="fas fa-user"></i>
              </div>
              <div>
                <div style="font-weight: 600">المدير العام</div>
                <div style="font-size: 0.9rem; color: var(--text-secondary)">
                  admin@umrah.com
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- إحصائيات -->
        <div class="stats-grid" id="statsGrid">
          <!-- سيتم تعبئتها عبر JS -->
        </div>
        <!-- المخططات -->
        <div class="charts-section">
          <div class="chart-card">
            <div class="chart-title">إحصائيات الحجوزات الشهرية</div>
            <canvas id="monthlyBookingsChart" height="180"></canvas>
          </div>
          <div class="chart-card">
            <div class="chart-title">توزيع الوكالات حسب الولاية</div>
            <canvas id="agencyDistributionChart" height="180"></canvas>
          </div>
        </div>
        <!-- الوكالات المعلقة -->
        <div class="pending-agencies">
          <h2 style="margin: 2rem 0 1rem 0">الوكالات في انتظار القبول</h2>
          <table id="pendingAgenciesTable">
            <thead>
              <tr>
                <th>الاسم</th>
                <th>الولاية</th>
                <th>الهاتف</th>
                <th>البريد الإلكتروني</th>
                <th>إجراء</th>
              </tr>
            </thead>
            <tbody>
              <!-- سيتم تعبئتها عبر JS -->
            </tbody>
          </table>
        </div>
        <!-- Modal تفاصيل الوكالة -->
        <div
          id="agencyDetailsModal"
          style="
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            align-items: center;
            justify-content: center;
          "
        >
          <div
            style="
              background: #fff;
              border-radius: 8px;
              max-width: 500px;
              width: 90%;
              margin: auto;
              padding: 2rem;
              position: relative;
              box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
            "
          >
            <button
              id="closeAgencyModal"
              style="
                position: absolute;
                left: 1rem;
                top: 1rem;
                background: none;
                border: none;
                font-size: 1.5rem;
                color: #888;
                cursor: pointer;
              "
            >
              &times;
            </button>
            <h3 style="margin-bottom: 1rem">تفاصيل الوكالة</h3>
            <div id="agencyDetailsContent">
              <!-- سيتم تعبئتها عبر JS -->
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
     <script src="includes/config.js"></script>
    <script>
    
      // جلب الإحصائيات من Supabase
      async function fetchDashboardData() {
        // إجمالي الوكالات
        const { count: totalAgencies } = await supabase
          .from("agences")
          .select("*", { count: "exact", head: true });

        // إجمالي المعتمرين
        const { count: totalPilgrims } = await supabase
          .from("demande_umrah")
          .select("*", { count: "exact", head: true });

        // إجمالي العروض
        const { count: totalOffers } = await supabase
          .from("offres")
          .select("*", { count: "exact", head: true });

        // الطلبات المعلقة
        const { count: pendingRequests } = await supabase
          .from("demande_umrah")
          .select("*", { count: "exact", head: true })
          .eq("statut", "en_attente");

        // الوكالات المعلقة (approuve = false)
        const { data: pendingAgencies } = await supabase
          .from("agences")
          .select("id, nom_agence, wilaya, telephone, email")
          .eq("approuve", false);

        // إحصائيات الحجوزات الشهرية (آخر 12 شهر)
        const { data: bookings } = await supabase
          .from("demande_umrah")
          .select("date_demande")
          .order("date_demande", { ascending: true });

        // تجهيز بيانات المخطط الشهري
        const months = [];
        const monthlyBookings = [];
        if (bookings && bookings.length) {
          const now = new Date();
          for (let i = 11; i >= 0; i--) {
            const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
            const ym = d.toISOString().slice(0, 7);
            months.push(ym);
            const count = bookings.filter(
              (b) => b.date_demande && b.date_demande.startsWith(ym)
            ).length;
            monthlyBookings.push(count);
          }
        }

        // توزيع الوكالات حسب الولاية (top 6)
        const { data: agencesWilaya } = await supabase
          .from("agences")
          .select("wilaya")
          .neq("wilaya", null);

        const wilayaCount = {};
        if (agencesWilaya) {
          agencesWilaya.forEach((a) => {
            if (!a.wilaya) return;
            wilayaCount[a.wilaya] = (wilayaCount[a.wilaya] || 0) + 1;
          });
        }
        const agencyLabels = Object.keys(wilayaCount)
          .sort((a, b) => wilayaCount[b] - wilayaCount[a])
          .slice(0, 6);
        const agencyCounts = agencyLabels.map((w) => wilayaCount[w]);

        return {
          stats: {
            totalAgencies: totalAgencies || 0,
            totalPilgrims: totalPilgrims || 0,
            totalOffers: totalOffers || 0,
            pendingRequests: pendingRequests || 0,
          },
          pendingAgencies: pendingAgencies || [],
          months,
          monthlyBookings,
          agencyLabels,
          agencyCounts,
        };
      }

      // تعبئة الإحصائيات
      function renderStats(stats) {
        const statsGrid = document.getElementById("statsGrid");
        statsGrid.innerHTML = `
            <div class="stat-card">
            <div class="stat-header">
                <div>
                <div class="stat-number">${stats.totalAgencies}</div>
                <div class="stat-label">إجمالي الوكالات</div>
                </div>
                <div class="stat-icon"><i class="fas fa-building"></i></div>
            </div>
            </div>
            <div class="stat-card">
            <div class="stat-header">
                <div>
                <div class="stat-number">${stats.totalPilgrims}</div>
                <div class="stat-label">إجمالي المعتمرين</div>
                </div>
                <div class="stat-icon"><i class="fas fa-users"></i></div>
            </div>
            </div>
            <div class="stat-card">
            <div class="stat-header">
                <div>
                <div class="stat-number">${stats.totalOffers}</div>
                <div class="stat-label">العروض النشطة</div>
                </div>
                <div class="stat-icon"><i class="fas fa-tags"></i></div>
            </div>
            </div>
            <div class="stat-card">
            <div class="stat-header">
                <div>
                <div class="stat-number">${stats.pendingRequests}</div>
                <div class="stat-label">الطلبات المعلقة</div>
                </div>
                <div class="stat-icon"><i class="fas fa-clock"></i></div>
            </div>
            </div>
        `;
      }

      // جلب تفاصيل وكالة واحدة
      async function fetchAgencyDetails(id) {
        const { data, error } = await supabase
          .from("agences")
          .select(
            "id, nom_agence, wilaya, telephone, email, photo_profil, photo_couverture, date_creation, commercial_license_number, latitude, longitude, langue_preferee"
          )
          .eq("id", id)
          .single();
        return data;
      }

      // عرض تفاصيل الوكالة في المودال
      function showAgencyDetailsModal(agency) {
        const modal = document.getElementById("agencyDetailsModal");
        const content = document.getElementById("agencyDetailsContent");
        content.innerHTML = `
          <div style="text-align:center;">
            ${
              agency.photo_profil
                ? `<img src="${agency.photo_profil}" alt="صورة الملف" style="width:80px;height:80px;border-radius:50%;object-fit:cover;margin-bottom:1rem;">`
                : ""
            }
            <h4 style="margin-bottom:0.5rem;">${agency.nom_agence || ""}</h4>
            <div style="color:#888; margin-bottom:1rem;">${
              agency.email || ""
            }</div>
          </div>
          <table style="width:100%; direction:rtl; border-collapse:collapse;">
            <tr><td style="padding:4px 0;">الولاية:</td><td>${
              agency.wilaya || ""
            }</td></tr>
            <tr><td style="padding:4px 0;">الهاتف:</td><td>${
              agency.telephone || ""
            }</td></tr>
            <tr><td style="padding:4px 0;">رقم الرخصة التجارية:</td><td>${
              agency.commercial_license_number || ""
            }</td></tr>
            <tr><td style="padding:4px 0;">تاريخ الإنشاء:</td><td>${
              agency.date_creation
                ? new Date(agency.date_creation).toLocaleString("ar-EG")
                : ""
            }</td></tr>
            <tr><td style="padding:4px 0;">اللغة المفضلة:</td><td>${
              agency.langue_preferee || ""
            }</td></tr>
            <tr><td style="padding:4px 0;">الموقع الجغرافي:</td><td>${
              agency.latitude && agency.longitude
                ? `${agency.latitude}, ${agency.longitude}`
                : ""
            }</td></tr>
          </table>
          ${
            agency.photo_couverture
              ? `<div style="margin-top:1rem;"><img src="${agency.photo_couverture}" alt="صورة الغلاف" style="width:100%;max-height:120px;object-fit:cover;border-radius:6px;"></div>`
              : ""
          }
        `;
        modal.style.display = "flex";
      }

      // إغلاق المودال
      document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("closeAgencyModal").onclick = function () {
          document.getElementById("agencyDetailsModal").style.display = "none";
        };
        // إغلاق عند الضغط خارج المودال
        document.getElementById("agencyDetailsModal").onclick = function (e) {
          if (e.target === this) this.style.display = "none";
        };
      });

      // تعبئة جدول الوكالات المعلقة
      function renderPendingAgencies(agencies) {
        const tbody = document.querySelector("#pendingAgenciesTable tbody");
        tbody.innerHTML = "";
        if (!agencies.length) {
          tbody.innerHTML = `<tr><td colspan="5">لا توجد وكالات معلقة حالياً.</td></tr>`;
          return;
        }
        agencies.forEach((agency) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${agency.nom_agence}</td>
            <td>${agency.wilaya}</td>
            <td>${agency.telephone}</td>
            <td>${agency.email}</td>
            <td>
                <button class="details-btn" data-id="${agency.id}" style="margin-left:6px;background:#0d6efd;color:#fff;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;">عرض التفاصيل</button>
                <button class="accept-btn" data-id="${agency.id}">قبول</button>
            </td>
            `;
          tbody.appendChild(tr);
        });
        // زر القبول
        document.querySelectorAll(".accept-btn").forEach((btn) => {
          btn.addEventListener("click", async function () {
            const id = this.getAttribute("data-id");
            this.disabled = true;
            this.textContent = "...";
            // تحديث approuve في supabase
            const { error } = await supabase
              .from("agences")
              .update({ approuve: true })
              .eq("id", id);
            if (!error) {
              this.textContent = "تم القبول";
              this.style.background = "#43e97b";
            } else {
              this.textContent = "خطأ!";
              this.style.background = "#dc3545";
            }
          });
        });
        // زر عرض التفاصيل
        document.querySelectorAll(".details-btn").forEach((btn) => {
          btn.addEventListener("click", async function () {
            const id = this.getAttribute("data-id");
            btn.disabled = true;
            const agency = await fetchAgencyDetails(id);
            btn.disabled = false;
            if (agency) showAgencyDetailsModal(agency);
          });
        });
      }

      // رسم المخططات
      function renderCharts(
        months,
        monthlyBookings,
        agencyLabels,
        agencyCounts
      ) {
        // مخطط الحجوزات الشهرية
        new Chart(
          document.getElementById("monthlyBookingsChart").getContext("2d"),
          {
            type: "line",
            data: {
              labels: months,
              datasets: [
                {
                  label: "الحجوزات",
                  data: monthlyBookings,
                  backgroundColor: "rgba(25, 135, 84, 0.2)",
                  borderColor: "#198754",
                  borderWidth: 3,
                  pointBackgroundColor: "#ffd700",
                  pointBorderColor: "#14532d",
                  tension: 0.4,
                  fill: true,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false } },
              scales: {
                x: { title: { display: true, text: "الشهر" } },
                y: {
                  beginAtZero: true,
                  title: { display: true, text: "عدد الحجوزات" },
                },
              },
            },
          }
        );
        // مخطط توزيع الوكالات
        new Chart(
          document.getElementById("agencyDistributionChart").getContext("2d"),
          {
            type: "pie",
            data: {
              labels: agencyLabels,
              datasets: [
                {
                  data: agencyCounts,
                  backgroundColor: [
                    "#198754",
                    "#ffd700",
                    "#43e97b",
                    "#fa709a",
                    "#fee140",
                    "#14532d",
                  ],
                  borderColor: "#fff",
                  borderWidth: 2,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: { legend: { position: "bottom" } },
            },
          }
        );
      }

      // تحميل البيانات وعرضها
      fetchDashboardData().then((data) => {
        renderStats(data.stats);
        renderPendingAgencies(data.pendingAgencies);
        renderCharts(
          data.months,
          data.monthlyBookings,
          data.agencyLabels,
          data.agencyCounts
        );
      });
    </script>
  </body>
</html>
